using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class ExplosionControllerPun2 : MonoBehaviour
{
    [Header("?????????v???C???[???W?????v??")]
    [SerializeField] private float jumpForce = 100.0f;

    [Header("????????????????????????????????????")]
    [SerializeField]
    private float _futtobiPower;

    [Header("?????????????????????????????????f?B???C")]
    [SerializeField]
    private float _startDelaySeconds = 0.1f;

    [Header("???????????t???[????")][SerializeField] private int _durationFrameCount = 1;

    [Header("?G?t?F?N?g???????????????????I????????????????")]
    [SerializeField]
    private float _stopSeconds = 2f;
    [SerializeField] private int explodeCost = 10;               //???????K?v???T?N?????{???R?X?g

    [SerializeField] private ParticleSystem _effect;

    [SerializeField] private AudioSource _sfx;

    [SerializeField] private SphereCollider _collider;

    private void Awake()
    {
        _effect.Stop();
        _sfx.Stop();
        _collider.enabled = false;

    }

    /// <summary>
    /// ???j????
    /// </summary>
    public void Explode()
    {
        if (this.GetComponent<PlayerPun2>().is_exploded)
        {
            // ?????????????????R???[?`??
            StartCoroutine(ExplodeCoroutine());
            // ?G?t?F?N?g????????????
            _effect.Play();
            _sfx.Play();
            Rigidbody rb = this.GetComponent<Rigidbody>();  // rigidbody??????
            Vector3 force = new Vector3(0.0f, jumpForce, 0.0f);  // ?W?????v????????
            rb.AddForce(force);  // ??????????
            // ?????G?t?F?N?g?????????????????????R???[?`??
            StartCoroutine(StopCoroutine());
            
        }
    }

    private IEnumerator ExplodeCoroutine()
    {
        // ?w???b?????o??????????FixedUpdate????????
        var delayCount = Mathf.Max(0, _startDelaySeconds);
        while (delayCount > 0)
        {
            yield return new WaitForFixedUpdate();
            delayCount -= Time.fixedDeltaTime;
        }

        // ?????o?????????R???C?_???L???????????????????????????o??
        _collider.enabled = true;

        // ?????t???[?????L????
        for (var i = 0; i < _durationFrameCount; i++)
        {
            yield return new WaitForFixedUpdate();
        }

        // ????????????????
        _collider.enabled = false;
    }

    private IEnumerator StopCoroutine()
    {
        // ?????o??????????
        yield return new WaitForSeconds(_stopSeconds);
        _effect.Stop();
        _sfx.Stop();
        _collider.enabled = false;
        //this.GetComponent<Player>().is_exploded = false;
        //Destroy(gameObject);
        GetComponent<PlayerPun2>().is_exploded = false;
        PlayerPun2.cherryCount /= 2;
        if (PlayerPun2.cherryCount < 0)
        {
            PlayerPun2.cherryCount = 0;
        }

    }

    /// <summary>
    /// ???????q?b?g??????????????????????????????
    /// </summary>
    private void OnTriggerEnter(Collider other)
    {
        // ??????????Rigidbody???z??????????????????
        var rigidBody = other.GetComponentInParent<Rigidbody>();

        // Rigidbody???????????????????????????????I????
        if (rigidBody == null) return;

        // ???????????????????????????????????????x?N?g????????
        var direction = (other.transform.position - transform.position).normalized;

        // ??????????
        // ForceMode???????????????????????i???????????????j
        rigidBody.AddForce(direction * _futtobiPower, ForceMode.VelocityChange);
        
    }

    
}
